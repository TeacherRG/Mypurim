<!DOCTYPE html>
<html lang="ru" translate="no">
<head>
    <meta charset="UTF-8" />
    <meta name="google" content="notranslate" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ü—Ä–∞–∑–¥–Ω–∏–∫ –ü—É—Ä–∏–º ‚Äî –ò–Ω—Ç–µ—Ä–∞–≤–∫—Ç–∏–≤–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@700;900&family=Cormorant+Garamond:ital,wght@1,400;1,500&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="stylesheet" href="styles.css" />

    <!-- PWA: Web App Manifest -->
    <link rel="manifest" href="/Favicon/site.webmanifest" />

    <!-- PWA: Theme color for browser chrome -->
    <meta name="theme-color" content="#1e1f3a" />

    <!-- PWA: iOS (Safari) support -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="–ü—É—Ä–∏–º" />
    <link rel="apple-touch-icon" href="/Favicon/apple-touch-icon.png" />

    <!-- PWA: Service Worker registration + Install prompt -->
    <script>
      // Register service worker
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .catch((err) => console.error('SW registration failed:', err));
        });
      }

      // --- Platform detection ---
      const _isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      const _isInStandalone = window.matchMedia('(display-mode: standalone)').matches
                           || window.navigator.standalone === true;

      // Capture the install prompt (Android/Chrome)
      let _deferredInstallPrompt = null;

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        _deferredInstallPrompt = e;
        // Show bottom banner (Android)
        const banner = document.getElementById('install-banner');
        if (banner) banner.hidden = false;
        // Show nav sidebar install button
        _updateNavInstallBtn();
      });

      window.addEventListener('appinstalled', () => {
        _deferredInstallPrompt = null;
        const banner = document.getElementById('install-banner');
        if (banner) banner.hidden = true;
        const footer = document.getElementById('nav-install-footer');
        if (footer) footer.hidden = true;
      });

      function _updateNavInstallBtn() {
        const footer = document.getElementById('nav-install-footer');
        if (!footer) return;
        // Already installed as PWA ‚Äî hide install UI
        if (_isInStandalone) { footer.hidden = true; return; }
        // iOS: always show (user must manually use Share ‚Üí Add to Home Screen)
        if (_isIOS) { footer.hidden = false; return; }
        // Android/Desktop: show only when browser provides install prompt
        footer.hidden = !_deferredInstallPrompt;
      }

      document.addEventListener('DOMContentLoaded', () => {
        // --- Bottom banner (Android) ---
        const installBtn  = document.getElementById('install-btn');
        const dismissBtn  = document.getElementById('install-dismiss');
        const banner      = document.getElementById('install-banner');

        if (installBtn) {
          installBtn.addEventListener('click', async () => {
            if (!_deferredInstallPrompt) return;
            _deferredInstallPrompt.prompt();
            await _deferredInstallPrompt.userChoice;
            _deferredInstallPrompt = null;
            if (banner) banner.hidden = true;
          });
        }
        if (dismissBtn) {
          dismissBtn.addEventListener('click', () => {
            if (banner) banner.hidden = true;
          });
        }

        // --- Nav sidebar install button ---
        _updateNavInstallBtn();

        const navInstallBtn  = document.getElementById('nav-install-btn');
        const iosModal       = document.getElementById('ios-install-modal');
        const iosModalClose  = document.getElementById('ios-modal-close');

        if (navInstallBtn) {
          navInstallBtn.addEventListener('click', async () => {
            if (_isIOS) {
              // iOS: show instructions modal
              if (iosModal) iosModal.hidden = false;
            } else if (_deferredInstallPrompt) {
              // Android: trigger native install
              _deferredInstallPrompt.prompt();
              const { outcome } = await _deferredInstallPrompt.userChoice;
              _deferredInstallPrompt = null;
              _updateNavInstallBtn();
              if (banner) banner.hidden = true;
            }
          });
        }

        if (iosModalClose) {
          iosModalClose.addEventListener('click', () => {
            if (iosModal) iosModal.hidden = true;
          });
        }
        if (iosModal) {
          iosModal.addEventListener('click', (e) => {
            if (e.target === iosModal) iosModal.hidden = true;
          });
        }
      });
    </script>
</head>
<body>

    <!-- PRELOADER -->
    <div id="preloader" class="preloader">
        <div class="preloader-clown">ü§°</div>
        <div class="preloader-text">–ü—É—Ä–∏–º –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
    </div>

    <!-- PWA INSTALL BANNER (Android/Chrome ‚Äî appears at bottom) -->
    <div id="install-banner" class="install-banner" hidden>
        <div class="install-banner-text">
            <strong>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</strong>
            <span>–†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω ¬∑ –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø —Å —ç–∫—Ä–∞–Ω–∞</span>
        </div>
        <button id="install-btn" class="install-banner-btn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <button id="install-dismiss" class="install-banner-dismiss" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </div>

    <!-- iOS INSTALL INSTRUCTIONS MODAL -->
    <div id="ios-install-modal" class="ios-install-modal" hidden>
        <div class="ios-install-modal-inner">
            <button class="ios-modal-close" id="ios-modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
            <div class="ios-install-icon">üì≤</div>
            <h3 class="ios-install-title">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ iPhone / iPad</h3>
            <ol class="ios-install-steps">
                <li>–ù–∞–∂–º–∏—Ç–µ <strong>¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª</strong> <span class="ios-share-icon">‚¨ÜÔ∏è</span> –≤ Safari</li>
                <li>–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –≤–Ω–∏–∑ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ<br><strong>¬´–ù–∞ —ç–∫—Ä–∞–Ω "–î–æ–º–æ–π"¬ª</strong></li>
                <li>–ù–∞–∂–º–∏—Ç–µ <strong>¬´–î–æ–±–∞–≤–∏—Ç—å¬ª</strong> –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É</li>
            </ol>
            <p class="ios-install-note">–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∑–Ω–∞—á–æ–∫ –ü—É—Ä–∏–º–∞ –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ –≤–∞—à–µ–º —ç–∫—Ä–∞–Ω–µ</p>
        </div>
    </div>

    <!-- HEADER -->
    <header class="site-header">
        <div class="header-top-row">
            <button class="nav-toggle" id="nav-toggle" aria-label="–ú–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏">
                <svg width="22" height="18" viewBox="0 0 22 18" fill="none" aria-hidden="true">
                    <rect width="22" height="2.5" rx="1.25" fill="currentColor"/>
                    <rect y="7.75" width="22" height="2.5" rx="1.25" fill="currentColor"/>
                    <rect y="15.5" width="22" height="2.5" rx="1.25" fill="currentColor"/>
                </svg>
            </button>
            <h1 class="header-main-title" data-i18n="headerTitle">–ü—É—Ä–∏–º ‚Äî –ø—Ä–∞–∑–¥–Ω–∏–∫ –µ–≤—Ä–µ–π—Å–∫–æ–≥–æ –Ω–∞—Ä–æ–¥–∞, —Å–µ–º—å–∏ –∏ –¥–µ—Ç–µ–π</h1>
            <div class="header-controls">
                <select id="lang-select" class="lang-select">
                    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                    <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                    <option value="de">Deutsch</option>
                    <option value="he">◊¢◊ë◊®◊ô◊™</option>
                    <option value="ru-uk">RU + UA</option>
                    <option value="ru-de">RU + DE</option>
                </select>
                <div class="music-player" id="music-player">
                    <div class="mp-title" id="mp-title">‚ô™ –ü—É—Ä–∏–º</div>
                    <div class="mp-controls">
                        <button class="mp-btn" id="mp-prev" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫">‚èÆ</button>
                        <button class="mp-btn mp-play" id="mp-play" aria-label="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏">‚ñ∂</button>
                        <button class="mp-btn" id="mp-next" aria-label="–°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫">‚è≠</button>
                    </div>
                    <div class="mp-bar" id="mp-bar"><div class="mp-bar-fill" id="mp-bar-fill"></div></div>
                </div>
            </div>
        </div>
        <div class="header-dedication-bar">
            <span class="dedication-ornament">‚ú¶</span>
            <p class="header-dedication" data-i18n="dedication">–ü–æ—Å–≤—è—â–∞–µ—Ç—Å—è –ø–æ–¥–Ω—è—Ç–∏—é –¥—É—à–∏ –ò—Ä–∏–Ω—ã –±–∞—Ç –°–∞—Ä–∞</p>
            <span class="dedication-ornament">‚ú¶</span>
        </div>
    </header>

    <!-- NAV OVERLAY -->
    <div class="nav-overlay" id="nav-overlay"></div>

    <!-- NAV POPUP -->
    <nav class="nav-popup" id="nav-popup" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —É—Ä–æ–∫–∞–º">
        <div class="nav-popup-header">
            <span class="nav-popup-title" data-i18n="sidebarTitle">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Ä–æ–∫–∞</span>
            <button class="nav-close" id="nav-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é">‚úï</button>
        </div>
        <ul id="sidebar-menu"></ul>
        <!-- INSTALL BUTTON ‚Äî shown on mobile when not yet installed -->
        <div class="nav-install-footer" id="nav-install-footer" hidden>
            <button class="nav-install-btn" id="nav-install-btn">
                <span class="nav-install-icon">üì≤</span>
                <span class="nav-install-label">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω</span>
            </button>
        </div>
    </nav>

    <!-- LAYOUT -->
    <div class="layout">

        <!-- MAIN CONTENT -->
        <main class="content" id="content"></main>

    </div>

    <!-- FOOTER -->
    <footer class="site-footer">
        <div class="footer-inner">
            <p>
                <span data-i18n="footerDvarRights">–ü—Ä–∞–≤–∞ –Ω–∞ ¬´–î–≤–∞—Ä –ú–∞–ª—Ö—É—Ç¬ª ¬© 2026 Shluchim Office International</span><br>
                <span data-i18n="footerAudioRights">–ü—Ä–∞–≤–∞ –Ω–∞ –∞—É–¥–∏–æ –∏ —Ä—É—Å—Å–∫—É—é –≤–µ—Ä—Å–∏—é –ú–µ–≥–∏–ª—ã ¬©</span> <a href="https://moshiach.ru" target="_blank">moshiach.ru</a><br>
                <span data-i18n="footerPhotoRights">–ü—Ä–∞–≤–∞ –Ω–∞ —Ñ–æ—Ç–æ –ú–µ–≥–∏–ª—ã –†–µ–±–µ –ú–∞–≥–∞—Ä–∞—à–∞ ¬©</span> <a href="https://yeshivesstam.com" target="_blank">yeshivesstam.com</a>
            </p>
            <p><span data-i18n="footerContact">–û—Ç–∑—ã–≤—ã –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</span> <a href="mailto:kosherletter@gmail.com">kosherletter@gmail.com</a></p>
            <p data-i18n="footerCredit">–°–∞–π—Ç —Å–æ–∑–¥–∞–Ω –†–∞–≤ –†–µ—É–≤–µ–Ω –ì—Ä–∏–Ω–±–µ—Ä–≥</p>
            <p data-i18n="footerCopyright">¬© –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã 2026</p>
            <p class="visitor-counter">
                <span data-i18n="visitorLabel">–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π:</span>
                <span id="visitor-count" class="visitor-count-num">‚Äî</span>
            </p>
        </div>
    </footer>

    <!-- Logger must be first: patches console.error/warn and installs global error handlers -->
    <script src="modules/logger.js"></script>
    <script src="i18n.js"></script>
    <script src="hangman.js"></script>
    <!-- Modules -->
    <script src="modules/config.js"></script>
    <script src="modules/storage.js"></script>
    <script src="modules/music-player.js"></script>
    <script src="modules/nav.js"></script>
    <script src="modules/section-core.js"></script>
    <script src="modules/section-loader.js"></script>
    <script src="modules/esther-scroll.js"></script>
    <script src="modules/hebrew-speech.js"></script>
    <script src="modules/megilla-listen.js"></script>
    <script src="modules/maharash-scroll.js"></script>
    <script src="modules/halacha.js"></script>
    <script src="modules/megilla-shop.js"></script>
    <script src="modules/tzedaka.js"></script>
    <script src="modules/dreidel.js"></script>
    <script src="modules/alcohol.js"></script>
    <script src="modules/spiral.js"></script>
    <script src="modules/shum.js"></script>
    <script src="modules/home.js"></script>
    <!-- Main entry point -->
    <script src="app.js"></script>
</body>
</html>
